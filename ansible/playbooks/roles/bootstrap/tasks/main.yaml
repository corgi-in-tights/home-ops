---
- name: Ensure required variables are set
  assert:
    that:
      - kubeconfig is defined
    fail_msg: "Required variable 'kubeconfig' is not defined!"

- name: Ensure required CLI tools are installed
  assert:
    that:
      - lookup('pipe', 'command -v ' ~ item ~ ' >/dev/null 2>&1 || echo missing') != 'missing'
    fail_msg: "Required CLI '{{ item }}' is not installed"
  loop:
    - helmfile
    - kubectl
    - kustomize
    - yq

- name: Apply Kubernetes namespaces for apps
  shell: |
      just log info "Running stage..." "stage" "$0"
      find "{{ kubernetes_dir }}/apps" -mindepth 1 -maxdepth 1 -type d | while IFS= read -r dir; do \
          if ! kustomize build "$dir" | yq ea -e 'select(.kind == "Namespace")' | kubectl apply --kubeconfig "{{ kubeconfig }}" --server-side --field-manager bootstrap --force-conflicts -f -; then \
              just log fatal "Failed to apply namespace" "stage" "$0" "namespace" "$(basename "$dir")"; \
          fi; \
      done

- name: Apply Kubernetes resources from template
  shell: just template "{{ role_path }}/templates/resources.yaml.j2" | kubectl apply --kubeconfig "{{ kubeconfig }}" --server-side --field-manager bootstrap --force-conflicts -f -

- name: Apply Helmfile CRDs
  block:
    - name: Render CRDs via Helmfile
      command: helmfile --kubeconfig "{{ kubeconfig }}" -f "{{ role_path }}/files/00-crds.yaml" template -q
      register: crds_output

    - name: Filter CRDs and apply
      shell: |
        echo "{{ crds_output.stdout }}" | yq ea -e 'select(.kind == "CustomResourceDefinition")' | \
        kubectl apply --kubeconfig "{{ kubeconfig }}" --server-side --field-manager bootstrap --force-conflicts -f -
      register: crd_apply
      failed_when: crd_apply.rc != 0

- name: Sync Helmfile apps
  block:
    - name: Run helmfile sync
      command: helmfile --kubeconfig "{{ kubeconfig }}" -f "{{ role_path }}/files/01-apps.yaml" sync --hide-notes
      register: helm_sync
      failed_when: helm_sync.rc != 0
