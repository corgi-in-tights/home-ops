---
- name: Setup 1Password Vault access and ephemeral SESSION_DATA host
  hosts: localhost
  gather_facts: false
  roles:
    - role: op_vault

- name: Setup Tailscale on nodes
  hosts: k3s_cluster
  become: true
  gather_facts: true
  roles:
    - role: tailscale
  vars:
    tailscale_auth_key: "{{ hostvars['SESSION_DATA']['tailscale_auth_key'] }}"

- name: Cluster prep
  hosts: k3s_cluster
  gather_facts: true
  become: true
  collections:
    - k3s.orchestration
  roles:
    - role: prereq
    - role: airgap
    - role: raspberrypi

- name: Setup K3S server
  hosts: server
  become: true
  collections:
    - k3s.orchestration
  roles:
    - role: k3s_server

- name: Setup K3S agent
  hosts: agent
  collections:
    - k3s.orchestration
  become: true
  roles:
    - role: k3s_agent

- name: Set kubeconfig api endpoint via Tailscale
  hosts: localhost
  gather_facts: false
  roles:
    - role: kubeconfig_endpoint
  vars:
    kubeconfig: "{{ lookup('env', 'KUBECONFIG') }}"
    tailscale_api_endpoint: "{{ hostvars[groups['server'][0]]['tailscale_node_ipv4'] }}"

- name: Bootstrap apps on the cluster
  hosts: localhost
  gather_facts: false
  roles:
    - role: bootstrap
  vars:
    kubeconfig: "{{ lookup('env', 'KUBECONFIG') }}"
    kubernetes_dir: "{{ lookup('env', 'KUBERNETES_DIR') }}"

- name: Cleanup Session Variables
  hosts: ephemeral
  gather_facts: false
  tasks:
    - name: Overwrite sensitive data in the volatile container
      add_host:
        tailscale_auth_key: "REDACTED"
  no_log: true
